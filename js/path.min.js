function CubicBezier(t,e,n,i,o,s){var r=t.x*(1-o)*(1-o)*(1-o)+3*e.x*(1-o)*(1-o)*o+3*n.x*(1-o)*o*o+i.x*o*o*o,a=t.y*(1-o)*(1-o)*(1-o)+3*e.y*(1-o)*(1-o)*o+3*n.y*(1-o)*o*o+i.y*o*o*o,d=s?Math.sqrt((s.x-r)*(s.x-r)+(s.y-a)*(s.y-a)):0;return{x:r,y:a,perimeter:d}}function setPercentage(t){for(var e,n,i,o=0,s=[0],r=1;r<t.length;r++)e=t[r-1],n=t[r],i=BezierLength([{x:e.x,y:e.y},{x:e.x_end,y:e.y_end},{x:n.x_start,y:n.y_start},{x:n.x,y:n.y}],200),o+=i,s.push(o);t.forEach(function(t,e){t.percentage=s[e]/o})}function BezierLength(t,e){var n,o=1/(e-1),s=0,r=[];for(i=0;e>i;i++)n=CubicBezier(t[0],t[1],t[2],t[3],i*o,r[i-1]),r.push(n),s+=n.perimeter;return s}function translateTemp(t,e){return"-webkit-transform:translate("+t+","+e+")"}function px2unit(t,e){return"rem"==e?t/50+"rem":"percentage"==e?100*t/375+"%":t+"px"}function addClass(t,e){t.className.search(new RegExp("(^|\\s)"+e+"(?=($|\\s))","i"))<0&&(t.className+=" "+e)}function removeClass(t,e){t.className=t.className.replace(new RegExp("(^|\\s)"+e+"(?=($|\\s))","i"),"")}function outputCSS(t,e){e=e||{};var n,i,o=e.pointsCount||.07*e.duration,s=0,r=0,a=0,d="";for(console.log(o);o>=s;)r=s/o,time="linear"==e.timingFunction?{y:r}:CubicBezier({x:0,y:0},{x:e.motion_p0x,y:e.motion_p0y},{x:e.motion_p1x,y:e.motion_p1y},{x:1,y:1},r),s++,i=n=t[0],t.find(function(e,o){return 0!=e.percentage&&e.percentage>=time.y?(i=t[o],n=t[o-1],!0):void 0}),a=(time.y-n.percentage)/(i.percentage-n.percentage),pos=CubicBezier({x:n.x,y:n.y},{x:n.x_end,y:n.y_end},{x:i.x_start,y:i.y_start},{x:i.x,y:i.y},a),d+=(100*r).toFixed(4)+"%{"+[translateTemp(px2unit(pos.x-e.referenceX,e.unit),px2unit(pos.y-e.referenceY,e.unit)),e.alignCenter?"translate(-50%,-50%)":""].join(" ")+"}\n";return d}var XMLNS="http://www.w3.org/2000/svg",Coord=function(t){var e={};e.contain=document.getElementById(t),e.svg=document.createElementNS(XMLNS,"svg"),e.clientHeight=document.documentElement.clientHeight,e.clientWidth=document.documentElement.clientWidth,e.svg.height=e.clientHeight,e.svg.width=e.clientWidth,e.x=e.clientWidth/2,e.y=e.clientHeight/2,e.currentPath=null,e.state={canTransform:!1,pointMode:!1,lineMode:!1,canRemove:!1},e.paths=[],e.points={},e.option={},e.contain.appendChild(e.svg),e.tip=function(){function t(t){i.className="tip active";var e="";switch(t){case"point":e="点击添加锚点或拖拽锚点";break;case"line":e="可拖拽操控点";break;case"transform":e="可拖拽面板和路径";break;case"remove":e="点击移除锚点或操控点"}o.innerHTML=e}function n(){i.className="tip"}var i=document.createElement("div"),o=document.createElement("span");return i.className="tip",i.appendChild(o),e.contain.appendChild(i),{show:t,hide:n}}(),e.setCurrentPath=function(t){return e.paths.forEach(function(n){n==t||n.id==t?(n.active(!0),e.currentPath=n):n.active(!1)}),e.currentPath},e.removePath=function(t){e.paths.forEach(function(e){(e==t||e.id==t)&&e.remove()})},e.setOption=function(t){(!t||void 0!==t.standard)&&(this.option.standard=!(!t||!t.standard)||["w3c","webkit"])},e.path=function(){this.moveBy=function(t,e){n.forEach(function(n){n.movePointBy(t,e)})},this.active=function(t){this._active=t,i.setAttribute("stroke",t?"#000":"#CCC"),this.referenceDom_Y.style.display=t?null:"none",this.referenceDom_X.style.display=t?null:"none",n.forEach(function(e){t?e.show():e.hide()})},this.pointActive=function(){},this.addPoint=function(i,o,s,r){n.splice(r||n.length,0,new e.point(t,i,o,s)),t.draw()},this.removePoint=function(t){n=n.filter(function(e){return t==e||t==e.id?(e.remove(),!1):!0}),this.draw()},this.isShow=!0,this.draw=function(){i.setAttribute("stroke",this._active?"#000":"#CCC"),i.setAttribute("fill","none"),i.setAttribute("stroke-width","2");var t,o="";n.forEach(function(e,n,i){0==n?o+="M"+[e.x,e.y].join(" "):(t=i[n-1],o+="C"+[[t.x_end,t.y_end].join(" "),[e.x_start,e.y_start].join(" "),[e.x,e.y].join(" ")].join(","))}),i.setAttribute("d",o),setPercentage(n,this.option);var s=this.print();this.style.innerHTML=s,e.onCssChange&&e.onCssChange(s)},this.moveReference=function(t,e){"number"==typeof t&&(this.referenceDom_X.style.left=t+"px",this.option.referenceX=t),"number"==typeof e&&(this.referenceDom_Y.style.top=e+"px",this.option.referenceY=e),this.draw()},this.setReferenceTip=function(t){t?(this.referenceDom_tip.innerHTML=this.option.referenceX+"px,"+this.option.referenceY+"px",this.referenceDom_tip.style.left=this.option.referenceX+"px",this.referenceDom_tip.style.top=this.option.referenceY+"px",this.referenceDom_tip.style.display="block"):this.referenceDom_tip.style.display="none"},this.print=function(){if(n.length){var t=outputCSS(n,this.option);return"."+this.option.className+"{left:"+this.option.referenceX+"px;top:"+this.option.referenceY+"px;\n-webkit-animation:"+[this.option.className,this.option.duration+"ms","steps(1)",this.option.delay+"ms",this.option.iterationCount,this.option.direction?"alternate":"normal"].join(" ")+";}\n@-webkit-keyframes "+this.option.className+"{"+t+"}"}},this.remove=function(){e.svg.removeChild(i,e.svg),this.element.parentNode.removeChild(this.element,this.element.parentNode),this.referenceDom_Y.parentNode.removeChild(this.referenceDom_Y,this.referenceDom_Y.parentNode),this.referenceDom_X.parentNode.removeChild(this.referenceDom_X,this.referenceDom_X.parentNode),this.style.parentNode.removeChild(this.style,this.style.parentNode),n.forEach(function(t){t.remove()})},this.setOption=function(t){(!t||void 0!==t.duration)&&(this.option.duration=parseInt(t&&t.duration)?parseInt(t.duration):2e3),(!t||void 0!==t.iterationCount)&&(this.option.iterationCount=parseInt(t&&t.iterationCount)?parseInt(t.iterationCount):"infinite"),(!t||void 0!==t.delay)&&(this.option.delay=parseInt(t&&t.delay)?parseInt(t.delay):0),(!t||void 0!==t.className)&&(this.option.className=t&&t.className||"coordpath-"+this.id),(!t||void 0!==t.alignCenter)&&(this.option.alignCenter=!(!t||!t.alignCenter)||!0),(!t||void 0!==t.direction)&&(this.option.direction=!(!t||!t.direction)||!1),(!t||void 0!==t.unit)&&(this.option.unit=t&&t.unit||"px"),(!t||void 0!==t.referenceX)&&(this.option.referenceX=parseInt(t&&t.referenceX)?parseInt(t.referenceX):window.document.documentElement.clientWidth/2),(!t||void 0!==t.referenceY)&&(this.option.referenceY=parseInt(t&&t.referenceY)?parseInt(t.referenceY):window.document.documentElement.clientHeight/2),(!t||void 0!==t.image)&&(this.option.image=t&&t.image||{src:"",width:0,height:0}),(!t||void 0!==t.timingFunction)&&(this.option.timingFunction=t&&t.timingFunction||"linear"),"cubic-bezier"!==this.option.timingFunction?(this.option.motion_p0x=this.option.motion_p0y=0,this.option.motion_p1x=this.option.motion_p1y=1):((!t||void 0!==t.motion_p0x)&&(this.option.motion_p0x=t&&Number(t.motion_p0x)||0),(!t||void 0!==t.motion_p0y)&&(this.option.motion_p0y=t&&Number(t.motion_p0y)||0),(!t||void 0!==t.motion_p1x)&&(this.option.motion_p1x=t&&Number(t.motion_p1x)||1),(!t||void 0!==t.motion_p1y)&&(this.option.motion_p1y=t&&Number(t.motion_p1y)||1)),(!t||void 0!==t.className)&&(this.element.className="coord-elem "+this.option.className)},this.setImage=function(t,e,n){this.element.style.backgroundImage="url("+t+")",this.element.style.width=px2unit(e,this.option.unit),this.element.style.height=px2unit(n,this.option.unit)};var t=this,n=[];e.paths.push(this);var i=document.createElementNS(XMLNS,"path");this.id=e.guid(),this.element=document.createElement("div"),this.referenceDom_Y=document.createElement("span"),this.referenceDom_X=document.createElement("span"),this.referenceDom_tip=document.createElement("span"),this.style=document.createElement("style"),this.option={},this.setOption(),document.head.appendChild(this.style),this.referenceDom_Y.className="coord-reference-Y",this.referenceDom_Y.dataset.type="referenceY",this.referenceDom_tip.className="coord-reference-tip",this.referenceDom_X.dataset.type="referenceX",this.referenceDom_X.className="coord-reference-X",e.contain.appendChild(this.referenceDom_Y),e.contain.appendChild(this.referenceDom_X),e.contain.appendChild(this.referenceDom_tip),this.moveReference(this.option.referenceX,this.option.referenceY),e.contain.appendChild(this.element),e.svg.appendChild(i)},e.point=function(t,n,i){this.x=n,this.y=i,this.x_start=n,this.y_start=i,this.x_end=n,this.y_end=i,this.path=t,this.id=e.guid(),this.percentage=0;var o=this,s=document.createElement("div"),r=document.createElement("div"),a=document.createElementNS(XMLNS,"line"),d=document.createElement("div"),c=document.createElementNS(XMLNS,"line");s.dataset.type="point",s.dataset.pointid=this.id,s.className="coord-point",s.style.left=n+"px",s.style.top=i+"px",r.dataset.type="dot_start",r.dataset.pointid=this.id,r.className="coord-dot",r.style.left=n+"px",r.style.top=i+"px",d.dataset.type="dot_end",d.dataset.pointid=this.id,d.className="coord-dot",d.style.left=n+"px",d.style.top=i+"px",e.points[this.id]=this,e.contain.appendChild(s),e.contain.appendChild(d),e.contain.appendChild(r),e.svg.appendChild(c),e.svg.appendChild(a),a.setAttribute("stroke","#000"),a.setAttribute("fill","none"),a.setAttribute("stroke-width","1"),a.setAttribute("stroke-dasharray","3"),c.setAttribute("stroke","#000"),c.setAttribute("fill","none"),c.setAttribute("stroke-width","1"),c.setAttribute("stroke-dasharray","3"),this.draw=function(t){var e="start"==t?a:c;e.setAttribute("x1",this.x),e.setAttribute("y1",this.y),e.setAttribute("x2",this["x_"+t]),e.setAttribute("y2",this["y_"+t])},this.movePointTo=function(t,e){var n=t-this.x,i=e-this.y;o.movePointBy(n,i)},this.movePointBy=function(t,e){this.x+=t,this.y+=e,this.x_start+=t,this.y_start+=e,this.x_end+=t,this.y_end+=e,s.style.left=this.x+"px",s.style.top=this.y+"px",r.style.left=this.x_start+"px",r.style.top=this.y_start+"px",d.style.left=this.x_end+"px",d.style.top=this.y_end+"px",this.draw("start"),this.draw("end"),this.path.draw()},this.moveDotTo=function(t,e,n){"dot_start"==t?(this.x_start=e,this.y_start=n,r.style.left=e+"px",r.style.top=n+"px",this.draw("start"),this.path.draw()):"dot_end"==t&&(this.x_end=e,this.y_end=n,d.style.left=e+"px",d.style.top=n+"px",this.draw("end"),this.path.draw())},this.removeDot=function(t){this.moveDotTo(t,this.x,this.y)},this.remove=function(){s.parentNode.removeChild(s),r.parentNode.removeChild(r),a.parentNode.removeChild(a),d.parentNode.removeChild(d),c.parentNode.removeChild(c)},this.show=function(){s.style.display=null,r.style.display=null,a.style.display=null,d.style.display=null,c.style.display=null},this.hide=function(){s.style.display="none",r.style.display="none",a.style.display="none",d.style.display="none",c.style.display="none"}},e.guid=function(){return"xxxxxxxxxxxxxxxxyxxxxxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=16*Math.random()|0,n="x"==t?e:3&e|8;return n.toString(16)})},e.setState=function(t){e.state.pointMode="point"==t,e.state.lineMode="line"==t,e.state.canRemove="remove"==t,e.state.canTransform="transform"==t,document.body.className=t?"coord-mode-"+t:"",t?e.tip.show(t):e.tip.hide()},window.addEventListener("keydown",function(t){e.state.pointMode=16===t.keyCode,e.state.canRemove=82===t.keyCode,e.state.lineMode=18===t.keyCode,e.state.canTransform=32===t.keyCode;var n=e.state.pointMode&&"point"||e.state.lineMode&&"line"||e.state.canRemove&&"remove"||e.state.canTransform&&"transform"||"";document.body.className=n?"coord-mode-"+n:"",n?e.tip.show(n):e.tip.hide(),t.stopPropagation(),t.preventDefault=!0}),window.addEventListener("keyup",function(){e.state.pointMode=!1,e.state.lineMode=!1,e.state.canTransform=!1,e.state.canRemove=!1,document.body.className="",n=null,e.tip.hide()});var n=null,i=null,o=!1,s={};return e.contain.addEventListener("contextmenu",function(){e.state.canTransform=!0,event.preventDefault(),event.stopPropagation()}),e.contain.addEventListener("mousedown",function(t){if(e.currentPath){o=!0,addClass(e.contain,"paused"),i=t.target.dataset.type;var r=t.target.dataset.pointid;s.x=t.x,s.y=t.y,"point"===i&&(n=e.points[r]),("dot_start"===i||"dot_end"===i)&&(n=e.points[r],n.isCompound=n.x_start==n.x&&n.x_end==n.x&&n.y_start==n.y&&n.y_end==n.y?!0:!1),e.state.canTransform,e.state.canRemove&&"point"==i&&n.path.removePoint(n),!e.state.canRemove||"dot_start"!=i&&"dot_end"!=i||n.removeDot(i,n.x,n.y),e.state.pointMode&&e.svg==t.target&&e.currentPath.addPoint(t.x,t.y,"point"),t.preventDefault(),t.stopPropagation()}}),document.body.addEventListener("mouseup",function(){e.currentPath&&e.currentPath.setReferenceTip(!1),n=null,i=null,o=!1,removeClass(e.contain,"paused")}),document.body.addEventListener("mousemove",function(t){if(e.currentPath){var r=t.x-s.x,a=t.y-s.y;s.x=t.x,s.y=t.y,e.state.pointMode&&n&&n.movePointTo?n.movePointTo(t.x,t.y):e.state.canTransform&&o?e.currentPath.moveBy(r,a):e.state.lineMode&&n&&n.moveDotTo?(n.isCompound&&(n.moveDotTo("dot_start",t.x,t.y),n.moveDotTo("dot_end",2*n.x-t.x,2*n.y-t.y)),n.moveDotTo(i,t.x,t.y)):"referenceX"==i?(e.currentPath.moveReference(t.x),e.currentPath.setReferenceTip(!0)):"referenceY"==i&&(e.currentPath.moveReference(void 0,t.y),e.currentPath.setReferenceTip(!0))}}),e};